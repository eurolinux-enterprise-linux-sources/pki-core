From abaffc7d9115ddb22cd6a15f2d79c3b8fa6c00a2 Mon Sep 17 00:00:00 2001
From: J Magne <jmagne@localhost.localdomain.com>
Date: Mon, 18 May 2015 13:42:34 -0700
Subject: [PATCH] Bug 1220423 - XSS attacks on the dogtag administration page (port 9180, port 9444)

---
 .../cms/servlet/cert/GetCertFromRequest.java       |    3 +-
 .../netscape/cms/servlet/common/CMSTemplate.java   |  122 ++++++++++++++++----
 .../cms/servlet/profile/ProfileApproveServlet.java |    5 +-
 .../cms/servlet/profile/ProfileProcessServlet.java |    5 +-
 .../cms/servlet/profile/ProfileReviewServlet.java  |    7 +-
 .../cms/servlet/profile/ProfileSelectServlet.java  |    3 +-
 .../cms/servlet/profile/ProfileServlet.java        |   82 +-------------
 .../servlet/profile/ProfileSubmitCMCServlet.java   |    5 +-
 .../cms/servlet/profile/ProfileSubmitServlet.java  |    9 +-
 9 files changed, 124 insertions(+), 117 deletions(-)

diff --git a/base/common/src/com/netscape/cms/servlet/cert/GetCertFromRequest.java b/base/common/src/com/netscape/cms/servlet/cert/GetCertFromRequest.java
index 7f26021..6236729 100644
--- a/base/common/src/com/netscape/cms/servlet/cert/GetCertFromRequest.java
+++ b/base/common/src/com/netscape/cms/servlet/cert/GetCertFromRequest.java
@@ -40,6 +40,7 @@ import javax.servlet.http.*;
 import java.io.*;
 import java.util.Locale;
 import com.netscape.certsrv.apps.*;
+import com.netscape.cms.servlet.common.CMSTemplate;
 
 
 /**
@@ -162,7 +163,7 @@ public class GetCertFromRequest extends CMSServlet {
         } catch (NumberFormatException e) {
             log(ILogger.LL_FAILURE, CMS.getLogMessage("CMSGW_INVALID_REQ_ID_FORMAT", requestId));
             throw new EBaseException(
-                    CMS.getUserMessage(getLocale(httpReq), "CMS_BASE_INVALID_NUMBER_FORMAT_1", requestId));
+                    CMS.getUserMessage(getLocale(httpReq), "CMS_BASE_INVALID_NUMBER_FORMAT_1", CMSTemplate.escapeJavaScriptStringHTML(requestId)));
         }
 
         IRequest r = mQueue.findRequest(new RequestId(requestId));
diff --git a/base/common/src/com/netscape/cms/servlet/common/CMSTemplate.java b/base/common/src/com/netscape/cms/servlet/common/CMSTemplate.java
index ef250eb..7c39f8e 100644
--- a/base/common/src/com/netscape/cms/servlet/common/CMSTemplate.java
+++ b/base/common/src/com/netscape/cms/servlet/common/CMSTemplate.java
@@ -361,6 +361,7 @@ public class CMSTemplate extends CMSFile {
      * portion of an HTML document.
      * stevep - performance improvements - about 4 times faster than before.
      */
+
     public static String escapeJavaScriptString(String v) {
         int l = v.length();
         char in[] = new char[l];
@@ -372,18 +373,55 @@ public class CMSTemplate extends CMSFile {
         for (int i = 0; i < l; i++) {
             char c = in[i];
 
-            if ((c > 0x23) && (c!= 0x5c) && (c!= 0x3c) && (c!= 0x3e)) {
+            if ((c > 0x23) && (c != 0x5c) && (c != 0x3c) && (c != 0x3e) && (c != 0x3b)) {
                 out[j++] = c;
                 continue;
             }
 
+            /* some inputs are coming in as '\' and 'n' */
+            /* see BZ 500736 for details */
             if ((c == 0x5c) && ((i+1)<l) && (in[i+1] == 'n' ||
-                 in[i+1] == 'n' || in[i+1] == 'f' || in[i+1] == 't' ||
+                 in[i+1] == 'r' || in[i+1] == 'f' || in[i+1] == 't' ||
+                 in[i+1] == '<' || in[i+1] == '>' ||
+                 in[i+1] == 'x' || in[i+1] == ';' ||
                  in[i+1] == '\"' || in[i+1] == '\'' || in[i+1] == '\\')) {
-                out[j++] = '\\';
-                out[j++] = in[i+1];
-                i++;
-                continue;
+                if (in[i+1] == 'x' && ((i+3)<l) && in[i+2] == '3' &&
+                    (in[i+3] == 'c' || in[i+3] == 'e')) {
+                    out[j++] = '\\';
+                    out[j++] = in[i+1];
+                    out[j++] = in[i+2];
+                    out[j++] = in[i+3];
+                    i += 3;
+                    continue;
+                } else if (in[i+1] == '<' || in[i+1] == '>') {
+                    c = in[i+1];
+                    i++;
+                } else if (in[i+1] == ';') {
+                    out[j++] = in[i+1];
+                    i++;
+                    continue;
+                } else {
+                    out[j++] = '\\';
+                    out[j++] = in[i+1];
+                    i++;
+                    continue;
+                }
+            }
+            if (c == '&') {
+                int k;
+                for (k = 0; k < 8 && (i+k) < l; k++) {
+                    out[j+k] = in[i+k];
+                    if (in[i+k] == ';') break;
+                    if (in[i+k] == '<' || in[i+k] == '>') {
+                        k = 8;
+                        break;
+                    }
+                }
+                if (k < 8) {
+                    i += k;
+                    j += k + 1;
+                    continue;
+                }
             }
 
             switch (c) {
@@ -442,10 +480,11 @@ public class CMSTemplate extends CMSFile {
      * Like escapeJavaScriptString(String s) but also escape '[' for 
      * HTML processing. 
      */
+
     public static String escapeJavaScriptStringHTML(String v) {
         int l = v.length();
         char in[] = new char[l];
-        char out[] = new char[l * 4];
+        char out[] = new char[l * 8];
         int j = 0;
 
         v.getChars(0, l, in, 0);
@@ -453,17 +492,55 @@ public class CMSTemplate extends CMSFile {
         for (int i = 0; i < l; i++) {
             char c = in[i];
 
-            if (c > 0x5B) {
+            if (c > 0x5C) {
                 out[j++] = c;
                 continue;
             }
 
-            if ((c == 0x5c) && ((i+1)<l) && (in[i+1] == 'n' ||
-                 in[i+1] == 'n' || in[i+1] == 'f' || in[i+1] == 't')) {
-                out[j++] = '\\';
-                out[j++] = in[i+1];
-                i++;
-                continue;
+            if ((c == 0x5c) && ((i + 1) < l) && (in[i + 1] == 'n' ||
+                    in[i + 1] == 'r' || in[i + 1] == 'f' || in[i + 1] == 't' ||
+                    in[i + 1] == '<' || in[i + 1] == '>' ||
+                    in[i + 1] == 'x' || in[i + 1] == ';' ||
+                    in[i + 1] == '\"' || in[i + 1] == '\'' || in[i + 1] == '\\')) {
+                if (in[i + 1] == 'x' && ((i + 3) < l) && in[i + 2] == '3' &&
+                        (in[i + 3] == 'c' || in[i + 3] == 'e')) {
+                    out[j++] = '\\';
+                    out[j++] = in[i + 1];
+                    out[j++] = in[i + 2];
+                    out[j++] = in[i + 3];
+                    i += 3;
+
+                    continue;
+                } else if (in[i + 1] == '<' || in[i + 1] == '>') {
+                    c = in[i + 1];
+                    i++;
+                } else if (in[i + 1] == ';') {
+                    out[j++] = in[i + 1];
+                    i++;
+                    continue;
+                } else {
+                    out[j++] = '\\';
+                    out[j++] = in[i + 1];
+                    i++;
+                    continue;
+                }
+            }
+            if (c == '&') {
+                int k;
+                for (k = 0; k < 8 && (i + k) < l; k++) {
+                    out[j + k] = in[i + k];
+                    if (in[i + k] == ';')
+                        break;
+                    if (in[i + k] == '<' || in[i + k] == '>') {
+                        k = 8;
+                        break;
+                    }
+                }
+                if (k < 8) {
+                    i += k;
+                    j += k + 1;
+                    continue;
+                }
             }
 
             switch (c) {
@@ -498,16 +575,17 @@ public class CMSTemplate extends CMSFile {
                 break;
 
             case '<':
-                out[j++] = '\\';
-                out[j++] = 'x';
-                out[j++] = '3';
-                out[j++] = 'c';
+                out[j++] = '&';
+                out[j++] = 'l';
+                out[j++] = 't';
+                out[j++] = ';';
                 break;
+
             case '>':
-                out[j++] = '\\';
-                out[j++] = 'x';
-                out[j++] = '3';
-                out[j++] = 'e';
+                out[j++] = '&';
+                out[j++] = 'g';
+                out[j++] = 't';
+                out[j++] = ';';
                 break;
 
             default:
diff --git a/base/common/src/com/netscape/cms/servlet/profile/ProfileApproveServlet.java b/base/common/src/com/netscape/cms/servlet/profile/ProfileApproveServlet.java
index 8f3a0f6..1796afb 100644
--- a/base/common/src/com/netscape/cms/servlet/profile/ProfileApproveServlet.java
+++ b/base/common/src/com/netscape/cms/servlet/profile/ProfileApproveServlet.java
@@ -34,6 +34,7 @@ import com.netscape.certsrv.property.*;
 import com.netscape.certsrv.profile.*;
 import com.netscape.certsrv.logging.*;
 import com.netscape.cms.servlet.common.*;
+import com.netscape.cms.servlet.common.CMSTemplate;
 
 
 /**
@@ -344,14 +345,14 @@ public class ProfileApproveServlet extends ProfileServlet {
             args.set(ARG_ERROR_CODE, "1");
             args.set(ARG_ERROR_REASON, e.toString());
             args.set(ARG_ERROR_REASON, CMS.getUserMessage(locale,
-                    "CMS_PROFILE_NOT_FOUND", profileId));
+                    "CMS_PROFILE_NOT_FOUND", CMSTemplate.escapeJavaScriptString(profileId)));
             outputTemplate(request, response, args);
             return;
         }
         if (profile == null) {
             args.set(ARG_ERROR_CODE, "1");
             args.set(ARG_ERROR_REASON, CMS.getUserMessage(locale,
-                    "CMS_PROFILE_NOT_FOUND", profileId));
+                    "CMS_PROFILE_NOT_FOUND", CMSTemplate.escapeJavaScriptString(profileId)));
             outputTemplate(request, response, args);
             return;
         }
diff --git a/base/common/src/com/netscape/cms/servlet/profile/ProfileProcessServlet.java b/base/common/src/com/netscape/cms/servlet/profile/ProfileProcessServlet.java
index 4b8158c..e225952 100644
--- a/base/common/src/com/netscape/cms/servlet/profile/ProfileProcessServlet.java
+++ b/base/common/src/com/netscape/cms/servlet/profile/ProfileProcessServlet.java
@@ -38,6 +38,7 @@ import com.netscape.cms.servlet.common.*;
 
 import java.security.cert.*;
 import netscape.security.x509.*;
+import com.netscape.cms.servlet.common.CMSTemplate;
 
 
 /**
@@ -241,7 +242,7 @@ public class ProfileProcessServlet extends ProfileServlet {
         if (req == null) {
             args.set(ARG_ERROR_CODE, "1");
             args.set(ARG_ERROR_REASON, CMS.getUserMessage(locale,
-                    "CMS_REQUEST_NOT_FOUND", escapeJavaScriptString(requestId)));
+                    "CMS_REQUEST_NOT_FOUND", CMSTemplate.escapeJavaScriptStringHTML(requestId)));
             outputTemplate(request, response, args);
             if (statsSub != null) {
               statsSub.endTiming("approval");
@@ -303,7 +304,7 @@ public class ProfileProcessServlet extends ProfileServlet {
         if (profile == null) {
             args.set(ARG_ERROR_CODE, "1");
             args.set(ARG_ERROR_REASON, CMS.getUserMessage(locale,
-                    "CMS_PROFILE_NOT_FOUND", escapeJavaScriptString(profileId)));
+                    "CMS_PROFILE_NOT_FOUND", CMSTemplate.escapeJavaScriptStringHTML(profileId)));
             outputTemplate(request, response, args);
             if (statsSub != null) {
               statsSub.endTiming("approval");
diff --git a/base/common/src/com/netscape/cms/servlet/profile/ProfileReviewServlet.java b/base/common/src/com/netscape/cms/servlet/profile/ProfileReviewServlet.java
index 1591d5f..39d6c68 100644
--- a/base/common/src/com/netscape/cms/servlet/profile/ProfileReviewServlet.java
+++ b/base/common/src/com/netscape/cms/servlet/profile/ProfileReviewServlet.java
@@ -35,6 +35,7 @@ import com.netscape.certsrv.authorization.*;
 import com.netscape.certsrv.logging.*;
 import com.netscape.certsrv.ca.*;
 import com.netscape.cms.servlet.common.*;
+import com.netscape.cms.servlet.common.CMSTemplate;
 
 
 /**
@@ -184,7 +185,7 @@ public class ProfileReviewServlet extends ProfileServlet {
         if (req == null) {
             args.set(ARG_ERROR_CODE, "1");
             args.set(ARG_ERROR_REASON, CMS.getUserMessage(locale,
-                    "CMS_REQUEST_NOT_FOUND", requestId));
+                    "CMS_REQUEST_NOT_FOUND", CMSTemplate.escapeJavaScriptStringHTML(requestId)));
             outputTemplate(request, response, args);
             return;
         }
@@ -205,7 +206,7 @@ public class ProfileReviewServlet extends ProfileServlet {
         if (profile == null) {
             args.set(ARG_ERROR_CODE, "1");
             args.set(ARG_ERROR_REASON, CMS.getUserMessage(locale,
-                    "CMS_PROFILE_NOT_FOUND", profileId));
+                    "CMS_PROFILE_NOT_FOUND", CMSTemplate.escapeJavaScriptStringHTML(profileId)));
             outputTemplate(request, response, args);
             return;
         }
@@ -273,7 +274,7 @@ public class ProfileReviewServlet extends ProfileServlet {
             args.set(ARG_REQUEST_NOTES, "");
         } else {
             args.set(ARG_REQUEST_NOTES, 
-                req.getExtDataInString("requestNotes"));
+                CMSTemplate.escapeJavaScriptStringHTML(req.getExtDataInString("requestNotes")));
         }
 
         args.set(ARG_RECORD, list);
diff --git a/base/common/src/com/netscape/cms/servlet/profile/ProfileSelectServlet.java b/base/common/src/com/netscape/cms/servlet/profile/ProfileSelectServlet.java
index 7d0edbb..75f9af8 100644
--- a/base/common/src/com/netscape/cms/servlet/profile/ProfileSelectServlet.java
+++ b/base/common/src/com/netscape/cms/servlet/profile/ProfileSelectServlet.java
@@ -37,6 +37,7 @@ import com.netscape.certsrv.authentication.*;
 import com.netscape.certsrv.authorization.*;
 import com.netscape.certsrv.logging.*;
 import com.netscape.cms.servlet.common.*;
+import com.netscape.cms.servlet.common.CMSTemplate;
 
 import netscape.security.x509.*;
 
@@ -173,7 +174,7 @@ public class ProfileSelectServlet extends ProfileServlet {
         if (profile == null) {
             args.set(ARG_ERROR_CODE, "1");
             args.set(ARG_ERROR_REASON, CMS.getUserMessage(locale,
-                    "CMS_PROFILE_NOT_FOUND", profileId));
+                    "CMS_PROFILE_NOT_FOUND", CMSTemplate.escapeJavaScriptStringHTML(profileId)));
             outputTemplate(request, response, args);
             return;
         }
diff --git a/base/common/src/com/netscape/cms/servlet/profile/ProfileServlet.java b/base/common/src/com/netscape/cms/servlet/profile/ProfileServlet.java
index 4013229..e0b359a 100644
--- a/base/common/src/com/netscape/cms/servlet/profile/ProfileServlet.java
+++ b/base/common/src/com/netscape/cms/servlet/profile/ProfileServlet.java
@@ -38,6 +38,7 @@ import com.netscape.certsrv.property.*;
 import com.netscape.certsrv.template.*;
 import com.netscape.certsrv.request.*;
 import com.netscape.certsrv.logging.*;
+import com.netscape.cms.servlet.common.CMSTemplate;
 
 import netscape.security.x509.*;
 
@@ -321,92 +322,13 @@ public class ProfileServlet extends CMSServlet {
         }
     }
 
-    protected String escapeJavaScriptString(String v) {
-        int l = v.length();
-        char in[] = new char[l];
-        char out[] = new char[l * 4];
-        int j = 0;
-
-        v.getChars(0, l, in, 0);
-
-        for (int i = 0; i < l; i++) {
-            char c = in[i];
-
-            /* presumably this gives better performance */
-            if ((c > 0x23) && (c != 0x5c)) {
-                out[j++] = c;
-                continue;
-            }
-
-            /* some inputs are coming in as '\' and 'n' */
-            /* see BZ 500736 for details */
-            if ((c == 0x5c) && ((i+1)<l) && (in[i+1] == 'n' ||
-                 in[i+1] == 'n' || in[i+1] == 'f' || in[i+1] == 't')) {
-                out[j++] = '\\';
-                out[j++] = in[i+1];
-                i++;
-                continue;
-            }
-
-            switch (c) {
-            case '\n':
-                out[j++] = '\\';
-                out[j++] = 'n';
-                break;
-
-            case '\\':
-                out[j++] = '\\';
-                out[j++] = '\\';
-                break;
-
-            case '\"':
-                out[j++] = '\\';
-                out[j++] = '\"';
-                break;
-
-            case '\r':
-                out[j++] = '\\';
-                out[j++] = 'r';
-                break;
-
-            case '\f':
-                out[j++] = '\\';
-                out[j++] = 'f';
-                break;
-
-            case '\t':
-                out[j++] = '\\';
-                out[j++] = 't';
-                break;
-
-            case '<':
-                out[j++] = '\\';
-                out[j++] = 'x';
-                out[j++] = '3';
-                out[j++] = 'c';
-                break;
-
-            case '>':
-                out[j++] = '\\';
-                out[j++] = 'x';
-                out[j++] = '3';
-                out[j++] = 'e';
-                break;
-
-            default:
-                out[j++] = c;
-            }
-        }
-        return new String(out, 0, j);
-    }
-
     protected void outputArgString(PrintWriter writer, String name, ArgString str)
         throws IOException {	
         String s = str.getValue();
 
         // sub \n with "\n"
         if (s != null) {
-            s = escapeJavaScriptString(s); 
+            s = CMSTemplate.escapeJavaScriptStringHTML(s); 
         }
         writer.println(name + "=\"" + s + "\";");
     }
diff --git a/base/common/src/com/netscape/cms/servlet/profile/ProfileSubmitCMCServlet.java b/base/common/src/com/netscape/cms/servlet/profile/ProfileSubmitCMCServlet.java
index 27280d4..55e99a9 100644
--- a/base/common/src/com/netscape/cms/servlet/profile/ProfileSubmitCMCServlet.java
+++ b/base/common/src/com/netscape/cms/servlet/profile/ProfileSubmitCMCServlet.java
@@ -36,6 +36,7 @@ import com.netscape.cms.servlet.common.*;
 import com.netscape.cms.servlet.common.AuthCredentials;
 import org.mozilla.jss.asn1.*;
 import org.mozilla.jss.pkix.cmc.*;
+import com.netscape.cms.servlet.common.CMSTemplate;
 
 import netscape.security.x509.*;
 
@@ -316,7 +317,7 @@ profile, IRequest req) {
             seq.addElement(new INTEGER(0));
             UTF8String s = null;
             try {
-                s = new UTF8String(CMS.getUserMessage(locale, "CMS_PROFILE_NOT_FOUND", profileId));
+                s = new UTF8String(CMS.getUserMessage(locale, "CMS_PROFILE_NOT_FOUND", CMSTemplate.escapeJavaScriptStringHTML(profileId)));
             } catch (Exception ee) {
             }
             template.createFullResponseWithFailedStatus(response, seq,
@@ -332,7 +333,7 @@ profile, IRequest req) {
             seq.addElement(new INTEGER(0));
             UTF8String s = null;
             try {
-                s = new UTF8String(CMS.getUserMessage(locale, "CMS_PROFILE_NOT_FOUND", profileId));
+                s = new UTF8String(CMS.getUserMessage(locale, "CMS_PROFILE_NOT_FOUND", CMSTemplate.escapeJavaScriptStringHTML(profileId)));
             } catch (Exception ee) {
             }
             template.createFullResponseWithFailedStatus(response, seq,
diff --git a/base/common/src/com/netscape/cms/servlet/profile/ProfileSubmitServlet.java b/base/common/src/com/netscape/cms/servlet/profile/ProfileSubmitServlet.java
index 3892676..dae8d43 100644
--- a/base/common/src/com/netscape/cms/servlet/profile/ProfileSubmitServlet.java
+++ b/base/common/src/com/netscape/cms/servlet/profile/ProfileSubmitServlet.java
@@ -43,6 +43,7 @@ import com.netscape.cmsutil.xml.*;
 import com.netscape.cmsutil.util.*;
 import org.w3c.dom.*;
 import netscape.security.x509.*;
+import com.netscape.cms.servlet.common.CMSTemplate;
 
 
 /**
@@ -805,7 +806,7 @@ public class ProfileSubmitServlet extends ProfileServlet {
             } else {
                 args.set(ARG_ERROR_CODE, "1");
                 args.set(ARG_ERROR_REASON, CMS.getUserMessage(locale,
-                    "CMS_PROFILE_NOT_FOUND", profileId));
+                    "CMS_PROFILE_NOT_FOUND", CMSTemplate.escapeJavaScriptStringHTML(profileId)));
                 outputTemplate(request, response, args);
             }
             return;
@@ -816,7 +817,7 @@ public class ProfileSubmitServlet extends ProfileServlet {
             } else {
                 args.set(ARG_ERROR_CODE, "1");
                 args.set(ARG_ERROR_REASON, CMS.getUserMessage(locale,
-                    "CMS_PROFILE_NOT_FOUND", renewProfileId));
+                    "CMS_PROFILE_NOT_FOUND", CMSTemplate.escapeJavaScriptStringHTML(renewProfileId)));
                 outputTemplate(request, response, args);
             }
             return;
@@ -830,7 +831,7 @@ public class ProfileSubmitServlet extends ProfileServlet {
             } else {
                 args.set(ARG_ERROR_CODE, "1");
                 args.set(ARG_ERROR_REASON, CMS.getUserMessage(locale,
-                    "CMS_PROFILE_NOT_FOUND", profileId));
+                    "CMS_PROFILE_NOT_FOUND", CMSTemplate.escapeJavaScriptStringHTML(profileId)));
                 outputTemplate(request, response, args);
             }
             if (statsSub != null) {
@@ -848,7 +849,7 @@ public class ProfileSubmitServlet extends ProfileServlet {
             } else {
                 args.set(ARG_ERROR_CODE, "1");
                 args.set(ARG_ERROR_REASON, CMS.getUserMessage(locale,
-                    "CMS_PROFILE_NOT_FOUND", renewProfileId));
+                    "CMS_PROFILE_NOT_FOUND", CMSTemplate.escapeJavaScriptStringHTML(renewProfileId)));
                 outputTemplate(request, response, args);
             }
             return;
-- 
1.7.1

